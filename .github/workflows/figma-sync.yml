name: Figma Sync

on:
  schedule:
    # Runs every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all frames regardless of modification date'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'

jobs:
  sync-figma:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: .github/scripts

      - name: Run Figma sync
        id: figma_sync
        env:
          FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
          FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
        run: node .github/scripts/sync-figma.js
        continue-on-error: false

      - name: Check for changes
        id: git_diff
        run: |
          git diff --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.git_diff.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Update Figma screenshots and specifications

            Automated sync from Figma on ${{ github.event_name == 'schedule' && 'scheduled run' || 'manual trigger' }}
          branch: figma-sync/${{ github.run_number }}
          delete-branch: true
          title: 'Figma Sync: Update screenshots and specifications'
          body: |
            ## Figma Sync Update

            This PR contains automated updates from Figma:

            - ðŸ–¼ï¸ Updated screenshots for modified frames
            - ðŸ“ Updated design specifications
            - ðŸ•’ Sync triggered: ${{ github.event_name == 'schedule' && 'Scheduled (Monday 9 AM UTC)' || 'Manual trigger' }}
            - ðŸ“… Date: ${{ github.event.repository.updated_at }}

            ### Changes

            Review the diff to see which frames were updated with new screenshots and specifications.

            ---

            ðŸ¤– This PR was automatically generated by the Figma Sync workflow.
          labels: |
            figma-sync
            documentation
            automated
          assignees: ${{ github.repository_owner }}

      - name: Summary
        if: steps.git_diff.outputs.has_changes == 'true'
        run: |
          echo "âœ… Figma sync completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request has been created with the updated screenshots and specifications." >> $GITHUB_STEP_SUMMARY

      - name: No changes summary
        if: steps.git_diff.outputs.has_changes != 'true'
        run: |
          echo "â„¹ï¸ No Figma frames were modified since the last sync." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All documentation is up to date!" >> $GITHUB_STEP_SUMMARY
